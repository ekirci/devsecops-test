# Gitleaks for secret scanning & Trivy for IaC,SCA and docker image scanning
name: Gitleaks and Trivy Scanning

'on':
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  secrets_gitleaks:
    name: Gitleaks (Secrets)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Debug - verify gitleaks config exists
        run: |
          ls -lah
          test -f gitleaks.toml && echo "gitleaks.toml OK" || (echo "Missing gitleaks.toml" && exit 1)

      - name: Run Gitleaks (Docker CLI) -> SARIF
        id: gitleaks
        continue-on-error: true
        run: |
          docker run --rm -v "$PWD:/repo" -w /repo zricethezav/gitleaks:latest detect \
            --config gitleaks.toml \
            --no-git \
            --verbose \
            --report-format sarif \
            --report-path gitleaks.sarif
          echo "exitcode=$?" >> $GITHUB_OUTPUT

      - name: Debug - show gitleaks SARIF stats
        if: always()
        run: |
          ls -lah gitleaks.sarif || true
          jq '.runs[0].results | length' gitleaks.sarif || true

      - name: Upload SARIF (Gitleaks)
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: gitleaks.sarif
          category: 'gitleaks'

      - name: Upload Gitleaks SARIF artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-sarif
          path: gitleaks.sarif

      - name: Gate on secrets (fail if leaks found)
        if: steps.gitleaks.outputs.exitcode != '0'
        run: |
          echo "Gitleaks found secrets. Failing the job."
          exit 1

  trivy_config:
    name: Trivy config (IaC + Dockerfile)
    runs-on: ubuntu-latest
    needs: secrets_gitleaks
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Trivy config scan -> SARIF
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-config.sarif'
          severity: 'HIGH,CRITICAL'
          exit-code: '0'

      - name: Debug - verify SARIF exists
        if: always()
        run: |
          ls -lah trivy-config.sarif || true
          jq '.runs[0].results | length' trivy-config.sarif || true

      - name: Upload SARIF (Trivy config)
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-config.sarif'
          category: 'trivy-config'

      - name: Upload Trivy config SARIF artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-config-sarif
          path: trivy-config.sarif

  trivy_fs:
    name: Trivy fs (SCA)
    runs-on: ubuntu-latest
    needs: secrets_gitleaks
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Trivy fs scan -> SARIF
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-fs.sarif'
          severity: 'HIGH,CRITICAL'
          ignore-unfixed: true
          exit-code: '0'

      - name: Debug - verify SARIF exists
        if: always()
        run: |
          ls -lah trivy-fs.sarif || true
          jq '.runs[0].results | length' trivy-fs.sarif || true

      - name: Upload SARIF (Trivy fs)
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-fs.sarif'
          category: 'trivy-fs'

      - name: Upload Trivy fs SARIF artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-fs-sarif
          path: trivy-fs.sarif

  trivy_image:
    name: Trivy image (Container vuln)
    runs-on: ubuntu-latest
    needs: [trivy_config, trivy_fs]
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build image
        run: docker build -t devsecops-demo:ci .

      - name: Trivy image scan -> SARIF
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: 'image'
          image-ref: 'devsecops-demo:ci'
          format: 'sarif'
          output: 'trivy-image.sarif'
          severity: 'HIGH,CRITICAL'
          ignore-unfixed: true
          exit-code: '0'

      - name: Debug - verify SARIF exists
        if: always()
        run: |
          ls -lah trivy-image.sarif || true
          jq '.runs[0].results | length' trivy-image.sarif || true

      - name: Upload SARIF (Trivy image)
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-image.sarif'
          category: 'trivy-image'

      - name: Upload Trivy image SARIF artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-image-sarif
          path: trivy-image.sarif

      - name: Debug - if build fails, rerun without BuildKit (extra logs)
        if: failure()
        run: |
          echo "Build failed, trying again with BuildKit disabled for verbose logs..."
          DOCKER_BUILDKIT=0 docker build -t devsecops-demo:ci . || true

      - name: Debug - end snapshot
        if: always()
        run: |
          echo "End of Trivy image job"
          ls -lah *.sarif 2>/dev/null || true
