#DAST-OWASP ZAP CI/CD Pipeline

name: DAST-OWASP ZAP CI/CD Pipeline

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

jobs:
    zap_baseline: 
        runs_on: ubuntu-latest
        timeout-minutes: 10

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Build app image
              run: docker build -t devsecops-test:ci .

            - name: Run app container
              run: docker run -d --name devsecops-test -p 5000:5000 devsecops-test:ci

            - name: wait for the app readiness in the container
              run: |
                for i in {1..30}; do
                     if curl -fsS http://127.0.0.1:5000/ >/dev/null; then
                         echo "App is up"
                         exit 0
                     fi
                         sleep 2
                 done
                 echo "App did not start in time"
                 docker logs devsecops-test
                 exit 1
            
            - name: OWASP ZAP baseline scan
              uses: zaproxy/action-baseline@v0.15.0
              with:
                target: 'http://127.0.0.1:5000'
                docker_name: 'ghcr.io/zaproxy/zaproxy:stable'
                cmd_options: '-m 2 -a -j -T 10'
                fail_action: false
                allow_issue_writing: false
                artifact_name: 'owaspzap_scan'

            - name: Cleanup
              if: always()
              run: docker rm -f devsecops-test || true